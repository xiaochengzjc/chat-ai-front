{"version":3,"sources":["uni-app:///main.js","webpack:///D:/learn/uniapp/tool-ai/tool-ai/pages/chat/chat.vue?fcad","webpack:///D:/learn/uniapp/tool-ai/tool-ai/pages/chat/chat.vue?7533","webpack:///D:/learn/uniapp/tool-ai/tool-ai/pages/chat/chat.vue?0f9a","webpack:///D:/learn/uniapp/tool-ai/tool-ai/pages/chat/chat.vue?b70e","uni-app:///pages/chat/chat.vue","webpack:///D:/learn/uniapp/tool-ai/tool-ai/pages/chat/chat.vue?ffee","webpack:///D:/learn/uniapp/tool-ai/tool-ai/pages/chat/chat.vue?0371"],"names":["wx","__webpack_require_UNI_MP_PLUGIN__","__webpack_require__","createPage","Page","mixins","data","question","answer","show","key","chat","type","nomore","pagenum","upOption","use","noMoreSize","downOption","auto","userInfo","socketTask","timer","onLoad","console","uni","url","methods","connectSocket","success","fail","that","reconnect","code","reason","sendSocketMessage","reslove","res","reject","handelMessage","msgObj","msg_id","user","content","msg_time","length","index","item","heart","clearInterval","checkToken","getUserInfo","downCallback","showWelcom","copy","title","icon","getAnswer","client_avatar","message"],"mappings":";;;;;;;;;;;;;AAAA;AAGA;AACA;AAHA;AACAA,EAAE,CAACC,iCAAiC,GAAGC,mBAAmB;AAG1DC,UAAU,CAACC,aAAI,CAAC,C;;;;;;;;;;;;;ACLhB;AAAA;AAAA;AAAA;AAAA;AAAA;AAA6H;AAC7H;AACwD;AACL;AACsC;;;AAGzF;AAC8K;AAC9K,gBAAgB,kLAAU;AAC1B,EAAE,0EAAM;AACR,EAAE,2FAAM;AACR,EAAE,oGAAe;AACjB;AACA;AACA;AACA;AACA;AACA,EAAE,+FAAU;AACZ;AACA;;AAEA;AACe,gF;;;;;;;;;;;;ACvBf;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;;;;;;;;;;;;;ACAA;AAAA;AAAA;AAAA;AAAA;AAAA;AACA;AACA;AACA;AACA,aAAa,uVAEN;AACP,KAAK;AACL;AACA,aAAa,yTAEN;AACP,KAAK;AACL;AACA,aAAa,iSAEN;AACP,KAAK;AACL;AACA,aAAa,qUAEN;AACP,KAAK;AACL;AACA,aAAa,qRAEN;AACP,KAAK;AACL;AACA,aAAa,iSAEN;AACP,KAAK;AACL;AACA,aAAa,iSAEN;AACP,KAAK;AACL;AACA,CAAC;AACD;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,GAAG;AACH;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;;;;;;;;;;;AC/DA;AAAA;AAAA;AAAA;AAAwpB,CAAgB,uoBAAG,EAAC,C;;;;;;;;;;;;;;;;;;;;;ACsD5qB;AACA;AACA;AAGA;AACA;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;eACA;EACAC;EAAA;EACAC;IACA;MACAC;MACAC;MACAC;MACAC;MACAC;MACAC;MACAC;MACAC;MACAC;QACAC;QACAC;MACA;MACAC;QACAC;MACA;MACAC;MACAC;MACAC;IACA;EACA;EACAC;IACAC;IACA;IACA;IACA;MACAC;QACAC;MACA;MACA;IACA;IACA;IACA;IACA;EACA;EACAC;IACAC;MACA;MAEA;QACA;MACA;MACA;QACA;MACA;MACA;QACAF;QACAG;UACAL;QACA;QACAM;UACAN;QACA;MACA;MAEA;QACAA;QACAO;MACA;MAEA;QACAA;MACA;MAGA;QACAP;MACA;MAEA;QACAA;MACA;IACA;IAEA;IACAQ;MACAR;MAEA;QACAO;UACAE;UACAC;UACAL;YACAL;UACA;UACAM;YACAN;UACA;QACA;MACA;MACAO;MACAA;IACA;IAEAI;MAAA;MACA;QACA;UACA7B;UACAuB;YACAO;cACAC;cACA;YACA;UACA;UACAP;YACAQ;cACAD;cACA;YACA;UACA;QACA;MACA;IACA;IAEAE;MAAA;QAAA;QAAA;UAAA;YAAA;cAAA;gBACAC;gBAEAC,SAKAD,OALAC,QACAC,OAIAF,OAJAE,MACA9B,OAGA4B,OAHA5B,MACA+B,UAEAH,OAFAG,SACAC,WACAJ,OADAI;gBAAA,MAEAhC;kBAAA;kBAAA;gBAAA;gBAAA;cAAA;gBAIA;gBACAiC;gBACAC;cAAA;gBAAA;kBAAA;kBAAA;gBAAA;gBACAC;gBAAA,MACAA;kBAAA;kBAAA;gBAAA;gBACAA;gBAEAA;kBACA;gBACA;gBAEAhB;gBAAA;cAAA;gBATAe;gBAAA;gBAAA;cAAA;gBAcA;gBACAf;kBACAA;gBACA;cAAA;cAAA;gBAAA;YAAA;UAAA;QAAA;MAAA;IACA;IAEAiB;MACA;MACA;QACAC;MACA;MACA;MACA;QACA;QACA;MACA;MACA;QACAlB;UACA;QAAA,CACA;UACAP;QACA;MACA;IACA;IAEA0B;MACA;MACA;QACA;MACA;QACA;MACA;IACA;IAEAC;MACA;MACA3B;MACA;QACA;MACA;QACA;QACA;MACA;IACA;IAEA4B;MACA;QACA;QACA;MACA;MACA;IACA;IACAC;MAAA;MAAA;QAAA;UAAA;YAAA;cAAA;gBACA;kBACA9C;kBACAC;gBACA;cAAA;cAAA;gBAAA;YAAA;UAAA;QAAA;MAAA;IACA;IACA8C;MACA7B;QACAnB;QACAuB;UACAJ;YACA8B;YACAC;UACA;QACA;MACA;IACA;IACAC;MAAA;MAAA;QAAA;QAAA;UAAA;YAAA;cAAA;gBACAX;gBAAA,IACA;kBAAA;kBAAA;gBAAA;gBACArB;kBACA8B;kBACAC;gBACA;gBAAA;cAAA;gBAGA;gBACA;gBACA;gBACA;gBACA;gBACA;gBACAjD;gBACAkC;gBACA;kBACAlC;kBACAC;kBACAiC;kBACAiB;gBACA;gBAEA;gBACA;gBACA;kBACA;gBACA;gBACAC;kBACA;kBACA;kBACA;gBACA;gBACA5B;gBACA;kBACA;kBACA;kBACA;gBAAA,CACA;kBACAN;oBACA8B;oBACAC;kBACA;kBACAhC;kBACA;kBAEA;oBACA;oBACA;sBACA;sBACA;wBACAuB;wBACAhB;wBACA;sBACA;oBACA;kBACA;kBACAA;gBACA;cAAA;cAAA;gBAAA;YAAA;UAAA;QAAA;MAAA;IACA;EACA;AACA;AAAA,2B;;;;;;;;;;;;;AClVA;AAAA;AAAA;AAAA;AAAuwC,CAAgB,kqCAAG,EAAC,C;;;;;;;;;;;ACA3xC;AACA,OAAO,KAAU,EAAE,kBAKd","file":"pages/chat/chat.js","sourcesContent":["import 'uni-pages';\n// @ts-ignore\nwx.__webpack_require_UNI_MP_PLUGIN__ = __webpack_require__;\nimport Vue from 'vue'\nimport Page from './pages/chat/chat.vue'\ncreatePage(Page)","import { render, staticRenderFns, recyclableRender, components } from \"./chat.vue?vue&type=template&id=bf16e7f4&scoped=true&\"\nvar renderjs\nimport script from \"./chat.vue?vue&type=script&lang=js&\"\nexport * from \"./chat.vue?vue&type=script&lang=js&\"\nimport style0 from \"./chat.vue?vue&type=style&index=0&id=bf16e7f4&lang=scss&scoped=true&\"\n\n\n/* normalize component */\nimport normalizer from \"!../../../../../../soft/HBuilderX/plugins/uniapp-cli/node_modules/@dcloudio/vue-cli-plugin-uni/packages/vue-loader/lib/runtime/componentNormalizer.js\"\nvar component = normalizer(\n  script,\n  render,\n  staticRenderFns,\n  false,\n  null,\n  \"bf16e7f4\",\n  null,\n  false,\n  components,\n  renderjs\n)\n\ncomponent.options.__file = \"pages/chat/chat.vue\"\nexport default component.exports","export * from \"-!../../../../../../soft/HBuilderX/plugins/uniapp-cli/node_modules/@dcloudio/vue-cli-plugin-uni/packages/vue-loader/lib/loaders/templateLoader.js??vue-loader-options!../../../../../../soft/HBuilderX/plugins/uniapp-cli/node_modules/@dcloudio/vue-cli-plugin-uni/packages/webpack-preprocess-loader/index.js??ref--17-0!../../../../../../soft/HBuilderX/plugins/uniapp-cli/node_modules/@dcloudio/webpack-uni-mp-loader/lib/template.js!../../../../../../soft/HBuilderX/plugins/uniapp-cli/node_modules/@dcloudio/vue-cli-plugin-uni/packages/webpack-uni-app-loader/page-meta.js!../../../../../../soft/HBuilderX/plugins/uniapp-cli/node_modules/@dcloudio/vue-cli-plugin-uni/packages/vue-loader/lib/index.js??vue-loader-options!../../../../../../soft/HBuilderX/plugins/uniapp-cli/node_modules/@dcloudio/webpack-uni-mp-loader/lib/style.js!./chat.vue?vue&type=template&id=bf16e7f4&scoped=true&\"","var components\ntry {\n  components = {\n    mescrollBody: function () {\n      return import(\n        /* webpackChunkName: \"uni_modules/mescroll-uni/components/mescroll-body/mescroll-body\" */ \"@/uni_modules/mescroll-uni/components/mescroll-body/mescroll-body.vue\"\n      )\n    },\n    uTransition: function () {\n      return import(\n        /* webpackChunkName: \"node-modules/uview-ui/components/u-transition/u-transition\" */ \"uview-ui/components/u-transition/u-transition.vue\"\n      )\n    },\n    uAvatar: function () {\n      return import(\n        /* webpackChunkName: \"node-modules/uview-ui/components/u-avatar/u-avatar\" */ \"uview-ui/components/u-avatar/u-avatar.vue\"\n      )\n    },\n    uLoadingIcon: function () {\n      return import(\n        /* webpackChunkName: \"node-modules/uview-ui/components/u-loading-icon/u-loading-icon\" */ \"uview-ui/components/u-loading-icon/u-loading-icon.vue\"\n      )\n    },\n    uIcon: function () {\n      return import(\n        /* webpackChunkName: \"node-modules/uview-ui/components/u-icon/u-icon\" */ \"uview-ui/components/u-icon/u-icon.vue\"\n      )\n    },\n    \"u-Input\": function () {\n      return import(\n        /* webpackChunkName: \"node-modules/uview-ui/components/u--input/u--input\" */ \"uview-ui/components/u--input/u--input.vue\"\n      )\n    },\n    uButton: function () {\n      return import(\n        /* webpackChunkName: \"node-modules/uview-ui/components/u-button/u-button\" */ \"uview-ui/components/u-button/u-button.vue\"\n      )\n    },\n  }\n} catch (e) {\n  if (\n    e.message.indexOf(\"Cannot find module\") !== -1 &&\n    e.message.indexOf(\".vue\") !== -1\n  ) {\n    console.error(e.message)\n    console.error(\"1. 排查组件名称拼写是否正确\")\n    console.error(\n      \"2. 排查组件是否符合 easycom 规范，文档：https://uniapp.dcloud.net.cn/collocation/pages?id=easycom\"\n    )\n    console.error(\n      \"3. 若组件不符合 easycom 规范，需手动引入，并在 components 中注册该组件\"\n    )\n  } else {\n    throw e\n  }\n}\nvar render = function () {\n  var _vm = this\n  var _h = _vm.$createElement\n  var _c = _vm._self._c || _h\n}\nvar recyclableRender = false\nvar staticRenderFns = []\nrender._withStripped = true\n\nexport { render, staticRenderFns, recyclableRender, components }","import mod from \"-!../../../../../../soft/HBuilderX/plugins/uniapp-cli/node_modules/babel-loader/lib/index.js!../../../../../../soft/HBuilderX/plugins/uniapp-cli/node_modules/@dcloudio/vue-cli-plugin-uni/packages/webpack-preprocess-loader/index.js??ref--13-1!../../../../../../soft/HBuilderX/plugins/uniapp-cli/node_modules/@dcloudio/webpack-uni-mp-loader/lib/script.js!../../../../../../soft/HBuilderX/plugins/uniapp-cli/node_modules/@dcloudio/vue-cli-plugin-uni/packages/vue-loader/lib/index.js??vue-loader-options!../../../../../../soft/HBuilderX/plugins/uniapp-cli/node_modules/@dcloudio/webpack-uni-mp-loader/lib/style.js!./chat.vue?vue&type=script&lang=js&\"; export default mod; export * from \"-!../../../../../../soft/HBuilderX/plugins/uniapp-cli/node_modules/babel-loader/lib/index.js!../../../../../../soft/HBuilderX/plugins/uniapp-cli/node_modules/@dcloudio/vue-cli-plugin-uni/packages/webpack-preprocess-loader/index.js??ref--13-1!../../../../../../soft/HBuilderX/plugins/uniapp-cli/node_modules/@dcloudio/webpack-uni-mp-loader/lib/script.js!../../../../../../soft/HBuilderX/plugins/uniapp-cli/node_modules/@dcloudio/vue-cli-plugin-uni/packages/vue-loader/lib/index.js??vue-loader-options!../../../../../../soft/HBuilderX/plugins/uniapp-cli/node_modules/@dcloudio/webpack-uni-mp-loader/lib/style.js!./chat.vue?vue&type=script&lang=js&\"","<template>\r\n\t<view class=\"chat\">\r\n\t\t<!-- 聊天记录 -->\r\n\t\t<mescroll-body ref=\"mescrollRef\" :auto=\"false\" @init=\"mescrollInit\" :down=\"downOption\" @down=\"downCallback\"\r\n\t\t\t:up=\"upOption\" @up=\"upCallback\">\r\n\t\t\t<view class=\"chat-item\" v-for=\"(item, index) in chat\" :key=\"index\">\r\n\t\t\t\t<!-- 问题框 -->\r\n\t\t\t\t<u-transition :show=\"true\" mode=\"fade-right\" v-if=\"item.question != ''\">\r\n\t\t\t\t\t<view class=\"chat-item__right\">\r\n\t\t\t\t\t\t<view class=\"chat-item__right-message\" @longtap=\"copy(item.question)\">\r\n\t\t\t\t\t\t\t{{ item.question }}\r\n\t\t\t\t\t\t</view>\r\n\t\t\t\t\t\t<u-avatar shape=\"square\" :src=\"item.client_avatar\"></u-avatar>\r\n\t\t\t\t\t</view>\r\n\t\t\t\t</u-transition>\r\n\t\t\t\t<!-- 答案框 -->\r\n\t\t\t\t<u-transition :show=\"true\" mode=\"fade-left\">\r\n\t\t\t\t\t<view class=\"chat-item__left u-flex\">\r\n\t\t\t\t\t\t<u-avatar src=\"/static/avatar.png\" shape=\"square\"></u-avatar>\r\n\t\t\t\t\t\t<view class=\"chat-item__left-right\">\r\n\t\t\t\t\t\t\t<view class=\"chat-item__left-name\"> 小AI助手 </view>\r\n\t\t\t\t\t\t\t<view class=\"chat-item__left-bottom\">\r\n\t\t\t\t\t\t\t\t<view class=\"chat-item__left-message\" @longtap=\"copy(item.answer)\">\r\n\t\t\t\t\t\t\t\t\t<text v-if=\"item.answer == 'error'\">网路错误</text>\r\n\t\t\t\t\t\t\t\t\t<text v-if=\"item.answer != 'error'\">{{ item.answer || \"思考中...\" }}</text>\r\n\t\t\t\t\t\t\t\t</view>\r\n\t\t\t\t\t\t\t\t<u-loading-icon v-if=\"item.answer == ''\"></u-loading-icon>\r\n\t\t\t\t\t\t\t\t<u-icon v-if=\"item.answer == 'error'\" name=\"error\"></u-icon>\r\n\t\t\t\t\t\t\t\t<view style=\"margin-top:auto;\">\r\n\t\t\t\t\t\t\t\t\t<u-icon v-if=\"item.answer && item.answer != error\" @tap=\"copy(item.answer)\"\r\n\t\t\t\t\t\t\t\t\t\tname=\"file-text\"></u-icon>\r\n\t\t\t\t\t\t\t\t</view>\r\n\t\t\t\t\t\t\t</view>\r\n\t\t\t\t\t\t</view>\r\n\t\t\t\t\t</view>\r\n\t\t\t\t</u-transition>\r\n\t\t\t</view>\r\n\t\t\t<view class=\"seize\" style=\"height: 200rpx\"></view>\r\n\t\t</mescroll-body>\r\n\t\t<!-- 底部输入框 -->\r\n\t\t<view class=\"input-box\">\r\n\t\t\t<view style=\"flex: 1;margin-right: 10rpx;\">\r\n\t\t\t\t<u--input placeholder=\"请输入内容\" border=\"surround\" v-model=\"question\">\r\n\t\t\t\t</u--input>\r\n\t\t\t</view>\r\n\t\t\t<view>\r\n\t\t\t\t<u-button iconColor=\"#ffffff\" color=\"#55aaff\" size=\"normal\" text=\"发送\" @tap=\"getAnswer\">\r\n\t\t\t\t</u-button>\r\n\t\t\t</view>\r\n\t\t</view>\r\n\t</view>\r\n</template>\r\n\r\n<script>\r\n\timport MescrollMixin from \"@/uni_modules/mescroll-uni/components/mescroll-uni/mescroll-mixins.js\";\r\n\timport $config from '@/common/config.js';\r\n\timport {\r\n\t\tv4 as uuidv4\r\n\t} from 'uuid';\r\n\timport {getToken } from '@/common/token.js'\r\n\timport {STORAGE_KEYS} from '@/common/constant.js'\r\n\texport default {\r\n\t\tmixins: [MescrollMixin], // 使用mixin (在main.js注册全局组件)\r\n\t\tdata() {\r\n\t\t\treturn {\r\n\t\t\t\tquestion: '',\r\n\t\t\t\tanswer: '',\r\n\t\t\t\tshow: false,\r\n\t\t\t\tkey: '',\r\n\t\t\t\tchat: [],\r\n\t\t\t\ttype: 'chat',\r\n\t\t\t\tnomore: false,\r\n\t\t\t\tpagenum: 1,\r\n\t\t\t\tupOption: {\r\n\t\t\t\t\tuse: false,\r\n\t\t\t\t\tnoMoreSize: 0\r\n\t\t\t\t},\r\n\t\t\t\tdownOption: {\r\n\t\t\t\t\tauto: false\r\n\t\t\t\t},\r\n\t\t\t\tuserInfo: {},\r\n\t\t\t\tsocketTask: null,\r\n\t\t\t\ttimer: null\r\n\t\t\t}\r\n\t\t},\r\n\t\tonLoad() {\r\n\t\t\tconsole.log(\"onLoad\")\r\n\t\t\t//检测用户是否登录\r\n\t\t\tlet islogin = this.checkToken();\r\n\t\t\tif (!islogin) {\r\n\t\t\t\tuni.navigateTo({\r\n\t\t\t\t\turl: '/pages/login/index' \r\n\t\t\t\t});\r\n\t\t\t\treturn false;\r\n\t\t\t}\r\n\t\t\tthis.getUserInfo()\r\n\t\t\tthis.showWelcom();\r\n\t\t\tthis.connectSocket();\r\n\t\t},\r\n\t\tmethods: {\r\n\t\t\tconnectSocket() {\r\n\t\t\t\tlet that = this\r\n\r\n\t\t\t\tif (that.userInfo == undefined) {\r\n\t\t\t\t\treturn \r\n\t\t\t\t}\r\n\t\t\t\tif (this.socketTask != null) {\r\n\t\t\t\t\tthis.socketTask.close()\r\n\t\t\t\t}\r\n\t\t\t\tthis.socketTask = uni.connectSocket({\r\n\t\t\t\t\turl: $config.wsUrl + '?uid=' + that.userInfo.id,\r\n\t\t\t\t\tsuccess(res) {\r\n\t\t\t\t\t\tconsole.log(\"websocket连接成功\");\r\n\t\t\t\t\t},\r\n\t\t\t\t\tfail(err) {\r\n\t\t\t\t\t\tconsole.log(\"websocket链接错误: \", err);\r\n\t\t\t\t\t}\r\n\t\t\t\t});\r\n\r\n\t\t\t\tthis.socketTask.onOpen(function(res) {\r\n\t\t\t\t\tconsole.log('WebSocket连接已打开');\r\n\t\t\t\t\tthat.heart()\r\n\t\t\t\t});\r\n\r\n\t\t\t\tthis.socketTask.onMessage(function(res) {\r\n\t\t\t\t\tthat.handelMessage(that, res.data)\r\n\t\t\t\t});\r\n\r\n\r\n\t\t\t\tthis.socketTask.onError(function(res) {\r\n\t\t\t\t\tconsole.log('WebSocket发生错误: ', res);\r\n\t\t\t\t});\r\n\r\n\t\t\t\tthis.socketTask.onClose((e) => {\r\n\t\t\t\t\tconsole.log('WebSocket连接关闭');\r\n\t\t\t\t});\r\n\t\t\t},\r\n\r\n\t\t\t//重新连接\r\n\t\t\treconnect(that) {\r\n\t\t\t\tconsole.log('websocket断线重连');\r\n\r\n\t\t\t\tif (that.socketTask != null) {\r\n\t\t\t\t\tthat.socketTask.close({\r\n\t\t\t\t\t\tcode: 1000,\r\n\t\t\t\t\t\treason: \"正常关闭\",\r\n\t\t\t\t\t\tsuccess: function(res) {\r\n\t\t\t\t\t\t\tconsole.log(\"主动关闭成功\", res);\r\n\t\t\t\t\t\t},\r\n\t\t\t\t\t\tfail: function(res) {\r\n\t\t\t\t\t\t\tconsole.log(\"主动关闭失败\", res);\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t})\r\n\t\t\t\t}\r\n\t\t\t\tthat.socketTask = null\r\n\t\t\t\tthat.connectSocket();\r\n\t\t\t},\r\n\r\n\t\t\tsendSocketMessage(msg) {\r\n\t\t\t\treturn new Promise((reslove, reject) => {\r\n\t\t\t\t\tthis.socketTask.send({\r\n\t\t\t\t\t\tdata: msg,\r\n\t\t\t\t\t\tsuccess(res) {\r\n\t\t\t\t\t\t\treslove({\r\n\t\t\t\t\t\t\t\tres: res,\r\n\t\t\t\t\t\t\t\t'msg': msg\r\n\t\t\t\t\t\t\t})\r\n\t\t\t\t\t\t},\r\n\t\t\t\t\t\tfail(res) {\r\n\t\t\t\t\t\t\treject({\r\n\t\t\t\t\t\t\t\tres: res,\r\n\t\t\t\t\t\t\t\t'msg': msg\r\n\t\t\t\t\t\t\t})\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t});\r\n\t\t\t\t})\r\n\t\t\t},\r\n\r\n\t\t\tasync handelMessage(that, msg) {\r\n\t\t\t\tlet msgObj = JSON.parse(msg)\r\n\t\t\t\tlet {\r\n\t\t\t\t\tmsg_id,\r\n\t\t\t\t\tuser,\r\n\t\t\t\t\ttype,\r\n\t\t\t\t\tcontent,\r\n\t\t\t\t\tmsg_time\r\n\t\t\t\t} = msgObj;\r\n\t\t\t\tif (type == \"heart\") {\r\n\t\t\t\t\treturn;\r\n\t\t\t\t}\r\n\r\n\t\t\t\t//从后往前遍历，找到对应的msg_id\r\n\t\t\t\tlet length = that.chat.length;\r\n\t\t\t\tfor (let index = length - 1; index >= 0; index--) {\r\n\t\t\t\t\tlet item = that.chat[index];\r\n\t\t\t\t\tif (item.msg_id == msg_id) {\r\n\t\t\t\t\t\titem.answer += content\r\n\r\n\t\t\t\t\t\titem.answer.length > 2 && item.answer.length < 5 && (item.answer = function(s) {\r\n\t\t\t\t\t\t\treturn s.replace(/(^\\n*)/g, \"\");\r\n\t\t\t\t\t\t}(item.answer))\r\n\r\n\t\t\t\t\t\tthat.$set(that.chat, index, item)\r\n\t\t\t\t\t\tbreak;\r\n\t\t\t\t\t}\r\n\t\t\t\t}\r\n\r\n\t\t\t\t//滚动到最下边\r\n\t\t\t\tthat.$nextTick(() => {\r\n\t\t\t\t\tthat.mescroll.scrollTo(99999999);\r\n\t\t\t\t});\r\n\t\t\t},\r\n\r\n\t\t\theart() {\r\n\t\t\t\tlet that = this;\r\n\t\t\t\tif (this.timer != null) {\r\n\t\t\t\t\tclearInterval(this.timer);\r\n\t\t\t\t}\r\n\t\t\t\tthis.timer = null;\r\n\t\t\t\tlet msg = {\r\n\t\t\t\t\t\"type\": \"heart\",\r\n\t\t\t\t\t\"content\": \"ping\"\r\n\t\t\t\t}\r\n\t\t\t\tthis.timer = setInterval(() => {\r\n\t\t\t\t\tthat.sendSocketMessage(JSON.stringify(msg)).then(res => {\r\n\t\t\t\t\t\t//console.log('心跳发送成功')\r\n\t\t\t\t\t}).catch(res => {\r\n\t\t\t\t\t\tconsole.log('发送心跳失败: ', res)\r\n\t\t\t\t\t})\r\n\t\t\t\t}, 30000)\r\n\t\t\t},\r\n\r\n\t\t\tcheckToken() {\r\n\t\t\t\tconst token = getToken()\r\n\t\t\t\tif (token == '' || token == undefined) {\r\n\t\t\t\t\treturn false;\r\n\t\t\t\t} else {\r\n\t\t\t\t\treturn true;\r\n\t\t\t\t}\r\n\t\t\t},\r\n\r\n\t\t\tgetUserInfo() {\r\n\t\t\t\tlet userInfo = uni.getStorageSync(STORAGE_KEYS.USER_INFO);\r\n\t\t\t\tconsole.log('getUserInfo', userInfo)\r\n\t\t\t\tif (userInfo == '' || userInfo == undefined) {\r\n\t\t\t\t\treturn false;\r\n\t\t\t\t} else {\r\n\t\t\t\t\tthis.userInfo = userInfo\r\n\t\t\t\t\treturn true;\r\n\t\t\t\t}\r\n\t\t\t},\r\n\r\n\t\t\tdownCallback() {\r\n\t\t\t\tif (this.pagenum <= 1 || this.nomore) {\r\n\t\t\t\t\tthis.mescroll.endErr();\r\n\t\t\t\t\treturn false;\r\n\t\t\t\t}\r\n\t\t\t\tthis.getAiQa(this.pagenum);\r\n\t\t\t},\r\n\t\t\tasync showWelcom() {\r\n\t\t\t\tthis.chat.push({\r\n\t\t\t\t\tquestion: '',\r\n\t\t\t\t\tanswer: '你好，我是小AI助手，请开始你的提问吧'\r\n\t\t\t\t});\r\n\t\t\t},\r\n\t\t\tcopy(val) {\r\n\t\t\t\tuni.setClipboardData({\r\n\t\t\t\t\tdata: this.answer || val,\r\n\t\t\t\t\tsuccess: function() {\r\n\t\t\t\t\t\tuni.showToast({\r\n\t\t\t\t\t\t\ttitle: '复制成功',\r\n\t\t\t\t\t\t\ticon: 'none'\r\n\t\t\t\t\t\t})\r\n\t\t\t\t\t}\r\n\t\t\t\t});\r\n\t\t\t},\r\n\t\t\tasync getAnswer() {\r\n\t\t\t\tlet index = this.chat.length\r\n\t\t\t\tif (!this.question) {\r\n\t\t\t\t\tuni.showToast({\r\n\t\t\t\t\t\ttitle: '你还没有输入问题呢！',\r\n\t\t\t\t\t\ticon: 'none'\r\n\t\t\t\t\t});\r\n\t\t\t\t\treturn\r\n\t\t\t\t}\r\n\t\t\t\t//智能回答参数拼接，固定格式，否则不会触发chatgpt智能回答\r\n\t\t\t\t// let query = '';\r\n\t\t\t\t// this.chat.forEach(item => {\r\n\t\t\t\t// \tquery += `Q: ${item.question}\\nA: ${item.answer}。 <|endoftext|>\\n`\r\n\t\t\t\t// })\r\n\t\t\t\t// query += `Q: ${this.question} + \"\\nA: `\r\n\t\t\t\tlet question = this.question;\r\n\t\t\t\tlet msg_id = uuidv4()\r\n\t\t\t\tthis.chat.push({\r\n\t\t\t\t\tquestion: this.question,\r\n\t\t\t\t\tanswer: '',\r\n\t\t\t\t\tmsg_id: msg_id,\r\n\t\t\t\t\tclient_avatar: this.userInfo.avatar\r\n\t\t\t\t});\r\n\r\n\t\t\t\tthis.question = '';\r\n\t\t\t\t// 数据渲染完毕再隐藏加载状态\r\n\t\t\t\tthis.$nextTick(() => {\r\n\t\t\t\t\tthis.mescroll.scrollTo(99999999);\r\n\t\t\t\t});\r\n\t\t\t\tlet message = {\r\n\t\t\t\t\t'type': 'req',\r\n\t\t\t\t\t'content': question,\r\n\t\t\t\t\t'msg_id': msg_id\r\n\t\t\t\t}\r\n\t\t\t\tlet that = this\r\n\t\t\t\tthis.sendSocketMessage(JSON.stringify(message)).then(function(data) {\r\n\t\t\t\t\t//发送成功 to do\r\n\t\t\t\t\t// let msgObj = JSON.parse(data.msg)\r\n\t\t\t\t\t// console.log(\"发送成功: \", data, msgObj)\r\n\t\t\t\t}, function(error) {\r\n\t\t\t\t\tuni.showToast({\r\n\t\t\t\t\t\ttitle: \"发送失败\",\r\n\t\t\t\t\t\ticon: 'none'\r\n\t\t\t\t\t})\r\n\t\t\t\t\tconsole.log(\"发送失败: \", error.res)\r\n\t\t\t\t\tlet msgObj = JSON.parse(error.msg)\r\n\r\n\t\t\t\t\tif (msgObj.type == \"req\") {\r\n\t\t\t\t\t\tlet length = that.chat.length\r\n\t\t\t\t\t\tfor (let index = length - 1; index >= 0; index--) {\r\n\t\t\t\t\t\t\tlet item = that.chat[index];\r\n\t\t\t\t\t\t\tif (item.msg_id == msgObj.msg_id) {\r\n\t\t\t\t\t\t\t\titem.answer = \"网络错误，请重新发送\"\r\n\t\t\t\t\t\t\t\tthat.$set(that.chat, index, item)\r\n\t\t\t\t\t\t\t\tbreak;\r\n\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t}\r\n\t\t\t\t\tthat.reconnect(that)\r\n\t\t\t\t})\r\n\t\t\t}\r\n\t\t}\r\n\t}\r\n</script>\r\n\r\n<style lang=\"scss\" scoped>\r\n\t.chat {\r\n\t\tpadding: 20rpx;\r\n\t\tbox-sizing: border-box;\r\n\r\n\t\t&-item {\r\n\t\t\t&__left {\r\n\t\t\t\tdisplay: flex;\r\n\t\t\t\tmargin-top: 20rpx;\r\n\r\n\t\t\t\t&-right {\r\n\t\t\t\t\tmargin-left: 20rpx;\r\n\t\t\t\t}\r\n\r\n\t\t\t\t&-name {\r\n\t\t\t\t\tfont-size: 24rpx;\r\n\t\t\t\t}\r\n\r\n\t\t\t\t&-message {\r\n\t\t\t\t\tmargin-top: 10rpx;\r\n\t\t\t\t\tbackground: #55aaff;\r\n\t\t\t\t\tpadding: 20rpx;\r\n\t\t\t\t\tborder-radius: 10rpx;\r\n\t\t\t\t\tfont-size: 28rpx;\r\n\t\t\t\t\tcolor: #fff;\r\n\t\t\t\t\tmargin-right: 20rpx;\r\n\t\t\t\t}\r\n\r\n\t\t\t\t&-bottom {\r\n\t\t\t\t\tdisplay: flex;\r\n\t\t\t\t}\r\n\t\t\t}\r\n\r\n\t\t\t&__right {\r\n\t\t\t\tdisplay: flex;\r\n\t\t\t\tmargin-top: 20rpx;\r\n\t\t\t\tjustify-content: flex-end;\r\n\r\n\t\t\t\t&-message {\r\n\t\t\t\t\tmargin-right: 20rpx;\r\n\t\t\t\t\tbackground: #98ff73;\r\n\t\t\t\t\tpadding: 20rpx;\r\n\t\t\t\t\tborder-radius: 10rpx;\r\n\t\t\t\t\tfont-size: 28rpx;\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t}\r\n\t}\r\n\r\n\t.input-box {\r\n\t\tdisplay: flex;\r\n\t\tbackground: #fff;\r\n\t\tposition: fixed;\r\n\t\t// #ifdef H5\r\n\t\tbottom: calc(env(safe-area-inset-bottom) + 50px);\r\n\t\tbottom: calc(constant(safe-area-inset-bottom) + 50px);\r\n\t\t// #endif\r\n\t\t// #ifndef H5\r\n\t\tbottom: 0;\r\n\t\t// #endif\r\n\t\tleft: 0;\r\n\t\twidth: 100%;\r\n\t\tpadding: 20rpx;\r\n\t\tbox-sizing: border-box;\r\n\t\tjustify-content: space-between;\r\n\t\talign-items: center;\r\n\t}\r\n</style>\n","import mod from \"-!../../../../../../soft/HBuilderX/plugins/uniapp-cli/node_modules/mini-css-extract-plugin/dist/loader.js??ref--8-oneOf-1-0!../../../../../../soft/HBuilderX/plugins/uniapp-cli/node_modules/css-loader/dist/cjs.js??ref--8-oneOf-1-1!../../../../../../soft/HBuilderX/plugins/uniapp-cli/node_modules/@dcloudio/vue-cli-plugin-uni/packages/vue-loader/lib/loaders/stylePostLoader.js!../../../../../../soft/HBuilderX/plugins/uniapp-cli/node_modules/@dcloudio/vue-cli-plugin-uni/packages/webpack-preprocess-loader/index.js??ref--8-oneOf-1-2!../../../../../../soft/HBuilderX/plugins/uniapp-cli/node_modules/postcss-loader/src/index.js??ref--8-oneOf-1-3!../../../../../../soft/HBuilderX/plugins/uniapp-cli/node_modules/@dcloudio/vue-cli-plugin-uni/packages/sass-loader/dist/cjs.js??ref--8-oneOf-1-4!../../../../../../soft/HBuilderX/plugins/uniapp-cli/node_modules/@dcloudio/vue-cli-plugin-uni/packages/webpack-preprocess-loader/index.js??ref--8-oneOf-1-5!../../../../../../soft/HBuilderX/plugins/uniapp-cli/node_modules/@dcloudio/vue-cli-plugin-uni/packages/vue-loader/lib/index.js??vue-loader-options!../../../../../../soft/HBuilderX/plugins/uniapp-cli/node_modules/@dcloudio/webpack-uni-mp-loader/lib/style.js!./chat.vue?vue&type=style&index=0&id=bf16e7f4&lang=scss&scoped=true&\"; export default mod; export * from \"-!../../../../../../soft/HBuilderX/plugins/uniapp-cli/node_modules/mini-css-extract-plugin/dist/loader.js??ref--8-oneOf-1-0!../../../../../../soft/HBuilderX/plugins/uniapp-cli/node_modules/css-loader/dist/cjs.js??ref--8-oneOf-1-1!../../../../../../soft/HBuilderX/plugins/uniapp-cli/node_modules/@dcloudio/vue-cli-plugin-uni/packages/vue-loader/lib/loaders/stylePostLoader.js!../../../../../../soft/HBuilderX/plugins/uniapp-cli/node_modules/@dcloudio/vue-cli-plugin-uni/packages/webpack-preprocess-loader/index.js??ref--8-oneOf-1-2!../../../../../../soft/HBuilderX/plugins/uniapp-cli/node_modules/postcss-loader/src/index.js??ref--8-oneOf-1-3!../../../../../../soft/HBuilderX/plugins/uniapp-cli/node_modules/@dcloudio/vue-cli-plugin-uni/packages/sass-loader/dist/cjs.js??ref--8-oneOf-1-4!../../../../../../soft/HBuilderX/plugins/uniapp-cli/node_modules/@dcloudio/vue-cli-plugin-uni/packages/webpack-preprocess-loader/index.js??ref--8-oneOf-1-5!../../../../../../soft/HBuilderX/plugins/uniapp-cli/node_modules/@dcloudio/vue-cli-plugin-uni/packages/vue-loader/lib/index.js??vue-loader-options!../../../../../../soft/HBuilderX/plugins/uniapp-cli/node_modules/@dcloudio/webpack-uni-mp-loader/lib/style.js!./chat.vue?vue&type=style&index=0&id=bf16e7f4&lang=scss&scoped=true&\"","// extracted by mini-css-extract-plugin\n    if(module.hot) {\n      // 1679817850360\n      var cssReload = require(\"D:/soft/HBuilderX/plugins/uniapp-cli/node_modules/mini-css-extract-plugin/dist/hmr/hotModuleReplacement.js\")(module.id, {\"hmr\":true,\"publicPath\":\"../../\",\"locals\":false});\n      module.hot.dispose(cssReload);\n      module.hot.accept(undefined, cssReload);\n    }\n  "],"sourceRoot":""}